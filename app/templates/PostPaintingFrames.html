<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>MiniAid</title>
        <link rel="stylesheet" type="text/css" href="../static/styles.css">
        <link rel="icon" type="image/x-icon" href="../static/favico.png">
        <script src="../static/JavaScript/notifications.js"></script>
        <script src="../static/JavaScript/imagesManagement.js"></script>
        <script src="../static/JavaScript/segmentation.js"></script>
        <script src="https://unpkg.com/vtk.js"></script>
        <script src="../static/JavaScript/reconstruction.js"></script>
        <script src="../static/JavaScript/blackPoint.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
    </head>
    <body>
        <div class = "body-head">
            <a class = "return-button" href="{{ url_for('post_painting_page') }}">
                <img src="../static/icons/arrow.png" class="return-icon">
                <h4>
                    Return
                </h4>
            </a>
            <div class = "body-text">
                <span class = "title">
                    MiniAid
                </span>
                <span class="subtitle">
                    Post-Painting
                </span>
            </div>
        </div>
        <div class="colors-sketchedimage">
            <div class="file-list">
                {% for frame in frames %}
                <div class="file-item" onclick="selectImage('{{ frame }}', previewImage)">
                    <img src="../static/icons/image.png" class="footer-icon">
                    <span>{{ frame }}</span>
                </div>
                {% endfor %}
                <div class="file-item upload-item" onclick="document.getElementById('frameUploadInput').click();" id="reUploadImage">
                    <form id="reUploadFormImage">
                        <input id="frameUploadInput" type="file" multiple accept="image/*" style="display:none;" required>
                        <span>Upload more images</span>
                    </form>
                </div>
                <div class="file-item delete-item" onclick="deleteAllImages();" id="deleteAllImages">
                    <span>Delete all images</span>
                </div> 
            </div>

            <div class="preview-section">
                <div class="image-preview">
                    <img id="preview-image" src="" alt="Select an image" style="display: none;">
                    <span id="no-selection-text">Select an image from the list</span>
                </div>
                
                <div class="action-buttons">
                    <button class="action-button" onclick="openSegmentationModal()">
                        <img src="../static/icons/segmentation.png" class="button-icon">
                        Segment Image
                    </button>

                    <button class="action-button" onclick="openBlackPointModal(previewImage.src)">
                        <img src="../static/icons/black_point.png" class="button-icon">
                        Modify Black Point
                    </button>
                    
                    <button class="action-button" onclick="openReconstructionModal(frames)">
                        <img src="../static/icons/sculpture.png" class="button-icon" >
                        Generate 3D Model
                    </button>
                </div>
            </div>
            
        </div>

        <div id="segmentationModal" class="modal">
            <div class="modal-content">
                <div>
                    <span class="close">&times;</span>

                    <div id="post-segment-text" style="text-align: center; margin-bottom: 25px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid var(--buttons-footer);">
                        <div style="font-weight: 600; font-size: 1.1em; margin-bottom: 8px; color: var(--buttons-footer);">‚úèÔ∏è Segmentation Controls</div>
                        <span style="display: block; margin-bottom: 5px;">üîπ Re-arrange the points to improve the segmentation</span>
                        <span style="color: #666; font-size: 0.9em;">üñ±Ô∏è Mouse wheel to zoom ‚Ä¢ SHIFT + Mouse to move</span>
                    </div>

                </div>

                <div class = "post-process-controls" id="postSegmentationControls" style="gap: 15px; height: 70vh;">
                    <div id="imageContainer" style="flex: 0 0 50%; min-width: 0; min-height: 0; height: 100%; display: flex; align-items: center; justify-content: center;">
                        <!-- Canvas will be injected here -->
                    </div>
                    <div class = "controls-buttons" style="flex: 1 1 50%; min-width: 0; min-height: 0; height: 100%;">
                        <!-- segmentation confidence removed: using semantic UNet model -->
                        <div class="slider-container">
                            <label for="smooth">Counter smoothness:</label>
                            <select id="segSmooth" class="custom-select">
                                <option value="low">Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                            </select>  
                        </div>

                        <div class="save-image-section" style="margin-top: 15px; padding: 15px; background: #f5f5f5; border-radius: 8px;">
                            <div style="margin-bottom: 10px;">
                                <label for="segmentationFilename" style="display: block; margin-bottom: 5px; font-weight: bold;">Filename:</label>
                                <input type="text" id="segmentationFilename" placeholder="my_segmented_image" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                            </div>
                            
                            <div style="margin-bottom: 10px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Target Size (px):</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="number" id="segmentationWidth" placeholder="Width" style="flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                                    <input type="number" id="segmentationHeight" placeholder="Height" style="flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                                </div>
                                <small style="color: #666;">Leave empty to keep original size</small>
                            </div>
                            
                            <div style="margin-bottom: 10px;">
                                <label style="display: flex; align-items: center; gap: 5px;">
                                    <input type="checkbox" id="segmentationEnableCrop">
                                    <span style="font-weight: bold;">Enable Crop Mode</span>
                                </label>
                                <small style="color: #666; display: block; margin-top: 5px;">When enabled, drag on the image to select crop area</small>
                            </div>
                        </div>

                        <div class = "adjustment-buttons" id="adjustSegmentation">
                            <div class = "action-button" id="reRunSegmentation">
                                <img src="../static/icons/reRun.png" class="button-icon">
                                Re-run segmentation
                            </div>
                            <div class = "action-button" id="downloadSegmented">
                                <img src="../static/icons/download.png" class="button-icon">
                                Save Image
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="blackPointModal" class="modal">
            <div class="modal-content">
                <div>
                    <span class="close">&times;</span>
                    <div style="text-align: center; margin-bottom: 25px;">
                        <span>Increase the black point to improve image darkness</span>
                    </div>
                </div>

                <div class = "post-process-controls" id="blackPointControls" style="height: 60vh;">
                    <div class="image-container" style="flex: 0 0 50%; min-width: 0; min-height: 0; height: 100%; display: flex; align-items: center; justify-content: center;">
                        <img id="blackPointImage" src="" alt="Selected image" style="object-fit: contain; height: 100%; width: 100%;">
                    </div>
                    <div class = "controls-buttons" style="flex: 1 1 50%; min-width: 0; min-height: 0; height: 100%;">
                        <div class="slider-container">
                            <label for="blackPointSlider">Black Point:</label>
                            <input type="range" id="blackPointSlider" min="0" max="100" value="20" step="1" class="slider">
                            <span id="blackPointValue">20%</span>
                        </div>

                        <div class="save-image-section" style="margin-top: 15px; padding: 15px; background: #f5f5f5; border-radius: 8px;">
                            <div style="margin-bottom: 10px;">
                                <label for="blackPointFilename" style="display: block; margin-bottom: 5px; font-weight: bold;">Filename:</label>
                                <input type="text" id="blackPointFilename" placeholder="my_adjusted_image" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                            </div>
                            
                            <div style="margin-bottom: 10px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Target Size (px):</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="number" id="blackPointWidth" placeholder="Width" style="flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                                    <input type="number" id="blackPointHeight" placeholder="Height" style="flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                                </div>
                                <small style="color: #666;">Leave empty to keep original size</small>
                            </div>
                            
                            <div style="margin-bottom: 10px;">
                                <label style="display: flex; align-items: center; gap: 5px;">
                                    <input type="checkbox" id="blackPointEnableCrop">
                                    <span style="font-weight: bold;">Enable Crop Mode</span>
                                </label>
                                <small style="color: #666; display: block; margin-top: 5px;">When enabled, drag on the image to select crop area</small>
                            </div>
                        </div>

                        <div class = "adjustment-buttons" id="adjustBlackPoint">
                            <div class = "action-button" id="downloadBlackPoint">
                                <img src="../static/icons/download.png" class="button-icon">
                                Save Image
                            </div>
                        </div>
                    </div>
                    
                </div>
            </div>
        </div>
        
        <div id="reconstructionModal" class="modal">
            <div class="modal-content">
                <div>
                    <span class="close">&times;</span>
                    <div style="text-align: center; margin-bottom: 25px; padding: 20px; background: linear-gradient(135deg, #297373 0%, #41B4B4 100%); border-radius: 10px; color: white;">
                        <h2 style="margin: 0; font-size: 1.8em; font-weight: 600;">üé® 3D Reconstruction</h2>
                        <p style="margin: 8px 0 0 0; font-size: 0.9em; opacity: 0.95;">Generate and visualize your 3D model</p>
                    </div>
                    <div id="reconstructionStatus" style="display:none; text-align:center; padding: 30px; background: #f8f9fa; border-radius: 10px; margin-bottom: 20px;">
                        <div class="loader"></div>
                        <div id="reconstructionMessage">Starting reconstruction...</div>
                    </div>
                    <div id="pointCloud" style="display:none;">
                            <div class = "post-process-controls" id="reconstructionControls" style="gap: 15px; height: 70vh;">
                                <div style="flex: 1 1 30%; min-width: 0; min-height: 0; height: 100%;"></div>
                                <div class="image-container" id="pointCloudScene" style="flex: 0 0 40%; min-width: 0; min-height: 0; height: 100%; display: block;"></div>
                                <div class="controls-buttons" style="flex: 1 1 30%; min-width: 0; min-height: 0; height: 100%; display:flex; gap:15px; align-items:center; flex-direction:column;">
                                <div style="margin-bottom:15px; padding: 20px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 10px; border-left: 4px solid var(--buttons-footer); width: 100%; box-sizing: border-box;">
                                    <div style="font-size: 1.2em; font-weight: 600; margin-bottom: 12px; color: var(--buttons-footer);">üßπ Point Cloud Cleaning</div>
                                    <div style="font-size: 0.9em; line-height: 1.6; color: #495057;">
                                        <div style="margin-bottom: 8px;">üñ±Ô∏è <b>Right mouse button</b> + hover to select points</div>
                                        <div style="margin-bottom: 8px;">üéØ Use slider below to adjust selection radius</div>
                                        <div>üóëÔ∏è Use buttons to delete or clear selection</div>
                                    </div>
                                </div>
                                <div style="width: 100%; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
                                <div class="slider-container" style="margin-bottom:10px;">
                                    <label for="selectionRadiusSlider">Selection Radius:</label>
                                    <input type="range" id="selectionRadiusSlider" min="0.01" max="0.2" value="0.05" step="0.01" class="slider">
                                    <span id="selectionRadiusValue">0.05</span>
                                </div>
                                <button id="deleteSelectedPC" class="action-button" style="flex: 1; min-width: 140px;">üóëÔ∏è Delete Selected</button>
                                <button id="clearSelectionPC" class="action-button" style="flex: 1; min-width: 140px;">‚ú® Clear Selection</button>
                                </div>
                            </div>
                            <div id="loader-container" style="display:flex; justify-content:center; align-items:center; height:80px;">
                                <div class="loader"></div>
                            </div>
                            <div class="image-container" id="pointCloudScene" style="width:900px; max-width:100vw; height:600px; display:block;"></div>
                            
                            <div class = "controls-buttons">
                                <div class="slider-container">
                                    <label for="pointCloudConfidenceSlider">Confidence:</label>
                                    <input type="range" id="pointCloudConfidenceSlider" min="0" max="100" value="50" step="1" class="slider">
                                    <span id="pointCloudConfidenceValue">50%</span>
                                </div>

                                <div class = "adjustment-buttons" style="gap: 12px;">
                                    <div class = "action-button" id="reRunPC" style="background: linear-gradient(135deg, #297373 0%, #2a7d7d 100%); box-shadow: 0 4px 6px rgba(41, 115, 115, 0.2);">
                                        üîÑ Update View
                                    </div>
                                    <div class = "action-button" id="downloadPC" style="background: linear-gradient(135deg, #297373 0%, #2a7d7d 100%); box-shadow: 0 4px 6px rgba(41, 115, 115, 0.2);">
                                        üíæ Download Point Cloud
                                    </div>
                                    <div class="action-button" id="generateMeshPC" style="background: linear-gradient(135deg, #41B4B4 0%, #4ac5c5 100%); box-shadow: 0 4px 6px rgba(65, 180, 180, 0.3); font-weight: 600;">
                                        ‚ú® Generate and View Mesh
                                    </div>
                                    <div class="action-button" id="downloadMeshPC" style="display:none; background: linear-gradient(135deg, #297373 0%, #2a7d7d 100%); box-shadow: 0 4px 6px rgba(41, 115, 115, 0.2);">
                                        üì• Download Mesh
                                    </div>
                                </div>
                            </div>
                            
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </body>
    <footer>
        <div class = "footer">
            <a href="https://github.com/GustavoSantiago113/MiniAid" target = "_blank" class="footer-icon-link">
                <img src="../static/icons/github.png" class="footer-icon">
            </a>
            <span class = "footer-text">
                Developed by: Gustavo N. Santiago <br> Under the Creative Common NonCommercial License
            </span>
            <a href="https://gustavosantiago.shinyapps.io/WebResume/" target = "_blank" class="footer-icon-link">
                <img src="../static/icons/webResume.png" class="footer-icon">
            </a>
        </div>
    </footer>
    <script>
        const previewImage = document.getElementById('preview-image');
        const canvas = document.getElementById("imageCanvas");
        document.getElementById("frameUploadInput").addEventListener("change", function () {
            sendMoreImageToFrames();
        });

        const slider = document.getElementById('blackPointSlider');
        function updateSlider() {
            const value = slider.value;
            const percent = (value / slider.max) * 100;
            slider.style.setProperty('--slider-percent', percent + '%');
        }
        slider.addEventListener('input', updateSlider);
        updateSlider();

        // segmentation confidence slider removed (UNet semantic segmentation)
        
        const sliderSelectRadius = document.getElementById('selectionRadiusSlider');
        function updateSliderSelectRadius() {
            const value = sliderSelectRadius.value;
            const percent = (value / sliderSelectRadius.max) * 100;
            sliderSelectRadius.style.setProperty('--slider-percent', percent + '%');
            document.getElementById('selectionRadiusValue').textContent = value;
        }
        sliderSelectRadius.addEventListener('input', updateSliderSelectRadius);
        updateSliderSelectRadius();

        const sliderPointCloud = document.getElementById('pointCloudConfidenceSlider');
        function updateSliderPointCloud() {
            const value = sliderPointCloud.value;
            const percent = (value / sliderPointCloud.max) * 100;
            sliderPointCloud.style.setProperty('--slider-percent', percent + '%');
        }
        sliderPointCloud.addEventListener('input', updateSliderPointCloud);
        updateSliderPointCloud();

        document.getElementById("downloadSegmented").addEventListener("click", function() {
            downloadSegmentedImage();
        });

        document.getElementById("downloadBlackPoint").addEventListener("click", function() {
            downloadBlackPointImage();
        });

        document.getElementById("reRunSegmentation").addEventListener("click", function() {
            reSegment();
        });

        document.getElementById("reRunPC").addEventListener("click", function() {
            updateVisualization();
        });

        document.getElementById("downloadPC").addEventListener("click", function() {
            downloadPointCloud();
        });

        document.getElementById('generateMeshPC').addEventListener('click', function() {
            generateAndViewMesh();
        });

        document.getElementById('downloadMeshPC').addEventListener('click', function() {
            downloadMeshPointCloud();
        });

    </script>
</html>